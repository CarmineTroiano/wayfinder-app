<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WayFinder Ultimate Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: { primary: '#6366f1', secondary: '#ec4899', accent: '#8b5cf6' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f3f4f6; }
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 1; }
        .activity-card { background: white; border-radius: 12px; padding: 10px; margin-bottom: 8px; border: 1px solid #f1f5f9; border-left-width: 5px; transition: all 0.2s; position: relative; cursor: grab; }
        .activity-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .in-timeline { background: #f8fafc; border: 1px solid #e2e8f0; border-left-width: 5px; }

        .note-card { transition: background-color 0.3s, border-left-color 0.3s; }
        .note-input { background: transparent; border: none; outline: none; width: 100%; font-size: 0.85rem; color: #4b5563; font-style: italic; resize: none; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.2); }

        #user-dropdown { transition: all 0.2s ease-out; opacity: 0; transform: scale(0.95); pointer-events: none; border: 1px solid #e2e8f0; }
        #user-dropdown.open { opacity: 1; transform: scale(1); pointer-events: auto; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; font-size: 14px; color: #475569; transition: all 0.15s; cursor: pointer !important; }
        .menu-item:hover { background-color: #f8fafc; color: #6366f1; }
        
        .delete-btn { position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; opacity: 0; transition: all 0.2s; z-index: 50; }
        .activity-card:hover .delete-btn { opacity: 1; top: 5px; right: 5px; }

        .map-legend { font-family: 'Poppins', sans-serif; font-size: 10px; line-height: 1.5; color: #334155; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        #pdf-template { display: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans overflow-hidden text-slate-800">

    <header class="bg-white/80 backdrop-blur-md border-b border-white/20 shadow-sm px-5 py-3 flex justify-between items-center z-30 shrink-0 sticky top-0 relative">
        <div class="flex items-center gap-3 text-primary">
            <h1 class="text-lg font-bold tracking-tight text-slate-800">WayFinder</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <button onclick="saveItineraryCheck()" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg text-xs font-bold hover:bg-green-200 transition flex items-center gap-2 shadow-sm">
                <i class="fas fa-save"></i> <span>SALVA VIAGGIO</span>
            </button>
            <div class="relative">
                <button onclick="toggleUserMenu()" class="flex items-center gap-3 bg-white border border-gray-200 hover:bg-gray-50 px-3 py-1.5 rounded-full transition shadow-sm cursor-pointer">
                    <span class="text-sm font-semibold text-slate-600 hidden sm:block"><%= user %></span>
                    <i class="fas fa-chevron-down text-[10px] text-gray-400"></i>
                </button>
                <div id="user-dropdown" class="absolute right-0 mt-3 w-64 bg-white rounded-xl shadow-2xl z-50">
                    <div class="px-5 py-3 border-b border-gray-50 bg-gray-50/50 rounded-t-xl">
                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wide mb-1">Account</p>
                        <p class="text-sm font-bold text-gray-800 truncate"><%= user %></p>
                    </div>
                    
                    <div class="py-2">
                        <div class="menu-item" onclick="window.location.href='/my-trips'">
                            <i class="fas fa-suitcase text-indigo-500"></i> <span>I miei Viaggi</span>
                        </div>
                        
                        <div class="menu-item menu-item-social group relative cursor-pointer" onclick="toggleSocialShare(event)">
                            <i class="fas fa-share-alt text-green-500"></i> 
                            <span class="flex-1">Condividi Viaggio</span>
                            <i class="fas fa-chevron-right text-[10px] ml-auto"></i>
                            
                            <div id="social-share-menu" class="absolute left-full top-0 w-48 bg-white rounded-xl shadow-xl z-50 py-2 border border-gray-100 hidden ml-2">
                                <div class="menu-item" onclick="shareLink('whatsapp', event)">
                                    <i class="fab fa-whatsapp text-green-500"></i> WhatsApp
                                </div>
                                <div class="menu-item" onclick="shareLink('telegram', event)">
                                    <i class="fab fa-telegram-plane text-blue-400"></i> Telegram
                                </div>
                                <div class="menu-item" onclick="shareLink('sms', event)">
                                    <i class="fas fa-sms text-yellow-500"></i> SMS
                                </div>
                            </div>
                        </div>
                        <div class="menu-item group relative" onclick="toggleLanguage()">
                            <i class="fas fa-globe text-blue-500"></i> <span class="flex-1">Lingua / Language</span>
                            <span id="currentLangDisplay" class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500 font-bold">IT</span>
                            <select id="langSelect" onchange="changeLanguage()" class="hidden"><option value="it">IT</option><option value="en">EN</option></select>
                        </div>
                        
                        <div class="my-1 border-t border-gray-100"></div>
                        <div class="menu-item" onclick="downloadPDF()"><i class="fas fa-file-pdf text-red-500"></i> <span>Scarica PDF</span></div>
                        <div class="my-1 border-t border-gray-100"></div>
                        <a href="/logout" class="menu-item text-red-600 hover:bg-red-50"><i class="fas fa-sign-out-alt"></i> <span>Esci</span></a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-[360px] bg-white border-r border-gray-200 flex flex-col z-20 shadow-xl shrink-0 h-full">
            <div class="flex-shrink-0">
                <div class="p-4 space-y-3 border-b border-dashed border-gray-200">
                    <input type="text" id="tripTitle" placeholder="Nome del viaggio..." class="w-full pl-3 p-2 bg-indigo-50/50 border border-indigo-100 rounded-xl text-xs font-bold text-indigo-800 outline-none">
                    <div class="relative group">
                        <input type="text" id="destination" autocomplete="off" placeholder="Dove vuoi andare?" class="w-full pl-3 p-2 bg-slate-50 border rounded-xl text-xs font-semibold outline-none">
                        <div id="autocomplete-list"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="startDate" class="w-full p-1.5 bg-slate-50 border rounded-lg text-xs">
                        <input type="date" id="endDate" class="w-full p-1.5 bg-slate-50 border rounded-lg text-xs">
                    </div>
                    <div>
                        <input type="hidden" id="searchMood" value="culturale">
                        <div class="mood-grid">
                            <div class="mood-card selected" onclick="setMood('culturale', this)"><span class="mood-icon">üèõÔ∏è</span><span class="mood-label">Cultura</span></div>
                            <div class="mood-card" onclick="setMood('gastronomico', this)"><span class="mood-icon">üçù</span><span class="mood-label">Gourmet</span></div>
                            <div class="mood-card" onclick="setMood('divertimento', this)"><span class="mood-icon">üç∏</span><span class="mood-label">Party</span></div>
                            <div class="mood-card" onclick="setMood('relax', this)"><span class="mood-icon">üçÉ</span><span class="mood-label">Relax</span></div>
                        </div>
                    </div>
                    <button onclick="startPlanning()" class="w-full bg-indigo-600 text-white py-2.5 rounded-xl font-bold text-sm shadow-md">TROVA LUOGHI</button>
                </div>
                <div class="px-4 py-2 bg-slate-50 border-b">
                    <input type="text" id="localSearch" onkeyup="if(event.key==='Enter')searchOnline();else filterBySearchTerm()" placeholder="Cerca o premi invio..." class="w-full p-2 border rounded text-xs outline-none">
                </div>
            </div>
            <div class="flex-1 min-h-0 overflow-y-auto p-3 bg-slate-50" id="scroll-container">
                <div id="suggestions-pool" class="space-y-2 pb-10"></div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-100 flex flex-col min-w-[380px] border-r border-gray-200 relative">
            <div class="p-3 bg-white border-b flex justify-between items-center z-10"><span class="text-xs font-bold text-slate-700 uppercase">ITINERARIO</span></div>
            <div id="timeline-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative z-0"></div>
        </main>

        <div class="w-[45%] relative group shadow-inner">
            <div id="map" class="z-0 h-full w-full"></div>
            <div id="loading" class="hidden absolute inset-0 bg-white/80 z-[2000] flex flex-col items-center justify-center"><p class="font-bold">CARICAMENTO...</p></div>
        </div>
    </div>

    <div id="pdf-template"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <script>
        const map = L.map('map', { preferCanvas: true, zoomControl: false }).setView([41.9028, 12.4964], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© OSM' }).addTo(map);
        let markersGroup = L.layerGroup().addTo(map);
        let allLoadedPlaces = []; 
        let tripDays = [];
        let markersMap = {}; 
        let addedPlaces = new Set(); 
        let filters = { top: false, culturale: true, attrazione: true, gastronomico: true, relax: true, divertimento: true };
        let currentTripId = null; 
        let currentCityCoords = { lat: 41.9028, lon: 12.4964 };

        document.getElementById('startDate').valueAsDate = new Date();
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 2);
        document.getElementById('endDate').valueAsDate = tomorrow;

        const CAT_DATA = { culturale: {color:'#8b5cf6',icon:'üèõÔ∏è'}, attrazione: {color:'#3b82f6',icon:'üìç'}, relax: {color:'#10b981',icon:'üå≥'}, gastronomico: {color:'#f97316',icon:'üç¥'}, divertimento: {color:'#ef4444',icon:'üç∏'}, altro: {color:'#64748b',icon:'üîπ'} };

        // --- GESTIONE NOTE (Con Colori e Bianco) ---
        function addNoteToDay(dayIndex, savedText = '', savedTime = '', savedBg = '#fef9c3', savedBorder = '#eab308') {
            const dayContent = document.getElementById(`day-content-${dayIndex}`);
            if(dayContent.parentElement.querySelector('.day-slot').classList.contains('hidden')) toggleDay(dayIndex);
            
            const card = document.createElement('div');
            card.className = `activity-card note-card in-timeline`;
            card.style.backgroundColor = savedBg;
            card.style.borderLeftColor = savedBorder;
            
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <textarea class="note-input" placeholder="Scrivi una nota..." rows="2">${savedText}</textarea>
                    <div class="delete-btn" onclick="this.parentElement.parentElement.remove(); updateCount();"><i class="fas fa-trash"></i></div>
                </div>
                <div class="mt-2 border-t border-black/5 pt-2 flex items-center gap-2">
                    <i class="far fa-clock text-gray-400 text-[10px]"></i>
                    <input type="time" value="${savedTime}" class="text-[10px] p-1 border rounded bg-white w-20">
                    <div class="flex gap-1 ml-auto">
                        <div class="color-dot bg-white border-gray-300" onclick="changeNoteColor(this, '#ffffff', '#e5e7eb')"></div>
                        <div class="color-dot bg-yellow-200" onclick="changeNoteColor(this, '#fef9c3', '#eab308')"></div>
                        <div class="color-dot bg-pink-200" onclick="changeNoteColor(this, '#fce7f3', '#db2777')"></div>
                        <div class="color-dot bg-blue-200" onclick="changeNoteColor(this, '#dbeafe', '#2563eb')"></div>
                        <div class="color-dot bg-green-200" onclick="changeNoteColor(this, '#dcfce7', '#16a34a')"></div>
                    </div>
                </div>
            `;
            dayContent.appendChild(card);
            updateCount();
        }

        function changeNoteColor(dot, bg, border) {
            const card = dot.closest('.note-card');
            card.style.backgroundColor = bg;
            card.style.borderLeftColor = border;
        }

        // --- SALVATAGGIO COMPLETO ---
        async function saveItineraryCheck() {
            const schedule = [];
            document.querySelectorAll('.day-slot').forEach(slot => {
                const dayItems = [];
                slot.querySelectorAll('.activity-card').forEach(card => {
                    const timeVal = card.querySelector('input[type="time"]')?.value || '';

                    if (card.classList.contains('note-card')) {
                        const text = card.querySelector('textarea').value;
                        const bg = card.style.backgroundColor;
                        const border = card.style.borderLeftColor;
                        dayItems.push({ type: 'note', text: text, time: timeVal, bg: bg, border: border });
                    } else {
                        dayItems.push({ type: 'place', id: card.dataset.id, time: timeVal });
                    }
                });
                schedule.push(dayItems);
            });

            const tripTitle = document.getElementById('tripTitle').value.trim() || document.getElementById('destination').value;
            let overwrite = false;

            if (currentTripId) {
                if (confirm(`Vuoi sovrascrivere "${tripTitle}"?\nOK = S√¨ (Sovrascrivi)\nAnnulla = No (Salva Copia)`)) overwrite = true;
            }

            const itineraryData = {
                id: currentTripId,
                title: tripTitle,
                destination: document.getElementById('destination').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                mood: document.getElementById('searchMood').value,
                places: allLoadedPlaces, 
                schedule: schedule 
            };

            try {
                const res = await fetch('/api/save-trip', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ itineraryData, overwrite })
                });
                const data = await res.json();
                if(data.success) {
                    currentTripId = data.tripId; 
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('tripId', data.tripId);
                    window.history.pushState({}, '', newUrl);
                    alert("Viaggio salvato con successo!");
                } else alert("Errore nel salvataggio.");
            } catch(e) { alert("Errore di connessione."); }
        }

        // --- CARICAMENTO ---
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tripId = urlParams.get('tripId');
            if(tripId) {
                document.getElementById('loading').classList.remove('hidden');
                try {
                    const res = await fetch(`/api/get-trip/${tripId}`);
                    const json = await res.json();
                    if(json.success && json.data) {
                        const saved = json.data;
                        currentTripId = saved.id;
                        document.getElementById('tripTitle').value = saved.title || "";
                        document.getElementById('destination').value = saved.destination;
                        document.getElementById('startDate').value = saved.startDate;
                        document.getElementById('endDate').value = saved.endDate;
                        setMood(saved.mood, document.querySelector(`.mood-card[onclick*="'${saved.mood}'"]`));
                        allLoadedPlaces = saved.places;
                        tripDays = generateDateSlots(saved.startDate, saved.endDate);
                        
                        if (saved.schedule) {
                            saved.schedule.forEach((dayItems, index) => {
                                const dayContent = document.getElementById(`day-content-${index}`);
                                if(dayContent) {
                                    dayItems.forEach(item => {
                                        const type = item.type || 'place';
                                        if (type === 'note') {
                                            // RIPRISTINA NOTA CON COLORI SALVATI
                                            addNoteToDay(index, item.text, item.time, item.bg, item.border);
                                        } else {
                                            const pid = item.id || item;
                                            const place = allLoadedPlaces.find(p => String(p.id) === String(pid));
                                            if (place) {
                                                const card = createCard(place, true, item.time);
                                                dayContent.appendChild(card);
                                                markAsAdded(pid);
                                            }
                                        }
                                    });
                                    if(dayItems.length>0) toggleDay(index);
                                }
                            });
                        }
                        renderApp();
                        updateCount();
                    }
                } catch(e) {}
                document.getElementById('loading').classList.add('hidden');
            }
        };

        // --- PDF GENERATOR PRO ---
        function downloadPDF() {
            const title = document.getElementById('tripTitle').value || "Mio Viaggio";
            const dest = document.getElementById('destination').value;
            const container = document.getElementById('pdf-template');
            
            let html = `<div style="padding: 40px; font-family: sans-serif;"><h1 style="color: #6366f1; font-size: 28px; border-bottom: 2px solid #ccc; padding-bottom: 10px;">${title}</h1><h2 style="color: #666; font-size: 16px; margin-top: 5px;">Destinazione: ${dest}</h2><div style="margin-top: 30px;">`;
            
            document.querySelectorAll('.day-slot').forEach((slot, index) => {
                const dateHeader = document.querySelectorAll('.bg-white.px-4 h3')[index]?.innerText || `Giorno ${index+1}`;
                const hasCards = Array.from(slot.children).some(c => c.classList.contains('activity-card'));

                if(hasCards) {
                    html += `<h3 style="margin-top: 25px; color: #333; font-size: 18px; background: #f3f4f6; padding: 5px 10px; border-radius: 5px;">${dateHeader}</h3><ul style="list-style: none; padding: 0;">`;
                    slot.querySelectorAll('.activity-card').forEach(card => {
                        const time = card.querySelector('input[type="time"]')?.value;
                        const timeStr = time ? `<b>${time}</b> ` : '';

                        if (card.classList.contains('note-card')) {
                            const text = card.querySelector('textarea').value;
                            const bg = card.style.backgroundColor || '#fef9c3';
                            const border = card.style.borderLeftColor || '#eab308';
                            html += `<li style="background:${bg}; padding:10px; margin-bottom:5px; border-left:4px solid ${border}; font-style:italic;">${timeStr} ${text}</li>`;
                        } else {
                            const name = card.querySelector('h4').innerText.replace('üî•','');
                            const cat = card.querySelector('span.uppercase').innerText;
                            const color = card.style.borderLeftColor;
                            html += `<li style="border-left: 5px solid ${color}; padding: 10px; margin-bottom: 8px; background: #fff; border: 1px solid #eee; border-left-color: ${color};">
                                ${timeStr} <strong style="font-size: 14px;">${name}</strong> <span style="font-size: 10px; color: #999; margin-left: 5px;">(${cat})</span>
                            </li>`;
                        }
                    });
                    html += `</ul>`;
                }
            });
            html += `</div><div style="margin-top:50px; text-align:center; color:#ccc; font-size:10px;">Generato con WayFinder Ultimate</div></div>`;
            container.innerHTML = html; container.style.display = 'block'; 
            html2pdf().set({ margin: 10, filename: `${title.replace(/\s+/g, '_')}.pdf`, image: {type:'jpeg', quality:0.98}, html2canvas: {scale: 2}, jsPDF: {unit:'mm', format:'a4'} }).from(container).save().then(() => { container.style.display = 'none'; });
        }

        // --- FUNZIONI CORE STANDARD ---
        function shareItinerary() {
            let text = `üåç ${document.getElementById('tripTitle').value || 'Mio Viaggio'} a ${document.getElementById('destination').value}:\n\n`;
            document.querySelectorAll('.day-slot').forEach((slot, index) => {
                if(slot.children.length > 0) {
                    text += `üìÖ Giorno ${index + 1}:\n`;
                    slot.querySelectorAll('.activity-card h4').forEach(h4 => text += ` - ${h4.innerText.replace('üî•', '')}\n`);
                    text += '\n';
                }
            });
            navigator.clipboard.writeText(text).then(() => alert("Copiato negli appunti!"));
        }

        function markAsAdded(id) {
            id = String(id);
            addedPlaces.add(id);
            const suggestionCard = document.querySelector(`.suggestion-card[data-id="${id}"]`);
            if (suggestionCard) suggestionCard.style.display = 'none';
            const marker = markersMap[id];
            if (marker) marker.setStyle({ color: '#047857', weight: 3, fillColor: '#10b981', fillOpacity: 1, radius: 8 });
        }

        function markAsRemoved(id) {
            id = String(id);
            addedPlaces.delete(id);
            const suggestionCard = document.querySelector(`.suggestion-card[data-id="${id}"]`);
            if (suggestionCard) {
                suggestionCard.style.display = 'block';
                suggestionCard.classList.remove('fade-in');
                void suggestionCard.offsetWidth; 
                suggestionCard.classList.add('fade-in');
            }
            const place = allLoadedPlaces.find(p => String(p.id) === id);
            const marker = markersMap[id];
            if (marker && place) {
                const style = CAT_DATA[place.category] || CAT_DATA.altro;
                marker.setStyle({ color: '#fff', weight: 2, fillColor: style.color, fillOpacity: 0.9, radius: 6 });
                marker.closePopup();
            }
        }
        
        function normalizeCategory(rawCategory) {
            if(!rawCategory) return 'altro';
            const lower = rawCategory.toLowerCase().trim();
            if (lower.includes('cibo') || lower.includes('gastronomico')) return 'gastronomico';
            if (lower.includes('party') || lower.includes('divertimento')) return 'divertimento';
            if (lower.includes('relax') || lower.includes('natura')) return 'relax';
            if (lower.includes('cultura') || lower.includes('arte')) return 'culturale';
            return 'attrazione';
        }

        function renderApp() {
            const pool = document.getElementById('suggestions-pool');
            const searchTerm = document.getElementById('localSearch').value.toLowerCase();
            pool.innerHTML = '';
            markersGroup.clearLayers();
            markersMap = {};
            let visibleCount = 0;
            allLoadedPlaces.forEach((place, index) => {
                const cat = place.category;
                if (!filters[cat]) return; 
                if (searchTerm && !place.name.toLowerCase().includes(searchTerm)) return;
                visibleCount++;
                drawMarker(place);
                const card = createCard(place, false);
                if(card.style.display !== 'none') {
                    card.style.animationDelay = `${Math.min(index * 0.05, 1)}s`;
                    card.classList.add('fade-in');
                }
                pool.appendChild(card);
            });
            if(visibleCount === 0) pool.innerHTML = `<div class="text-center mt-10 p-4 text-xs text-gray-400">Nessun risultato locale.<br>Premi <b>Invio</b> per cercare online.</div>`;
            initDragAndDrop();
        }

        function drawMarker(place) {
            const s = CAT_DATA[place.category] || CAT_DATA.altro;
            const c = L.circleMarker([place.lat, place.lng], {radius:6, fillColor:s.color, color:'#fff', weight:2, opacity:1, fillOpacity:0.9});
            const pop=`<div class="text-center p-2 min-w-[180px]"><b class="text-slate-800 text-sm block mb-1 truncate font-sans">${place.name}</b><span class="text-[9px] text-white px-2 py-0.5 rounded-full font-bold uppercase" style="background:${s.color}">${place.category}</span><p class="text-[10px] text-gray-500 mt-2 mb-2 line-clamp-2">${place.description}</p><button onclick="addToDay('${p.id}')" class="bg-indigo-600 text-white text-xs px-3 py-1 rounded w-full font-bold">Aggiungi +</button></div>`;
            c.bindPopup(pop);
            markersMap[p.id]=c;
            markersGroup.addLayer(c);
        }
        
        function createCard(p, isTimeline = false, savedTime = '') {
            const s = CAT_DATA[p.category] || CAT_DATA.altro;
            const ex = isTimeline ? 'in-timeline' : 'suggestion-card';
            const disp = (!isTimeline && addedPlaces.has(String(p.id))) ? 'none' : 'block';
            const card = document.createElement('div');
            card.className = `activity-card ${ex}`;
            card.style.display = disp;
            card.style.borderLeftColor = s.color;
            card.dataset.id = p.id;
            if (!isTimeline) {
                card.onmouseenter = () => highlightMarker(p.id);
                card.onmouseleave = () => resetMarker(p.id);
            }
            const fire = p.score > 800 ? '<span class="text-orange-500 ml-1" title="Top">üî•</span>' : '';
            const hide = isTimeline ? '' : 'hidden';
            card.innerHTML = `
                <div class="card-header pr-6">
                    <h4 class="font-semibold text-xs text-slate-800 leading-tight mb-1">${p.name} ${fire}</h4>
                    <div class="flex items-center gap-1.5">
                        <span class="text-[9px] uppercase font-bold tracking-wider" style="color:${s.color}">${s.icon} ${p.category}</span>
                    </div>
                </div>
                <div class="time-selector ${hide} mt-2 pt-2 border-t border-dashed border-slate-200 flex items-center gap-2">
                    <i class="far fa-clock text-slate-400 text-[10px]"></i>
                    <input type="time" value="${savedTime}" class="text-[10px] p-1 border border-slate-200 rounded bg-white text-slate-600 outline-none w-20 focus:border-indigo-400">
                </div>
            `;
            if (isTimeline) {
                const btn = document.createElement('div');
                btn.className = 'delete-btn';
                btn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                btn.onclick = () => { card.remove(); markAsRemoved(p.id); updateCount(); };
                card.appendChild(btn);
            }
            return card;
        }

        window.toggleDay = function(i) {
            const c = document.getElementById(`day-content-${i}`);
            const ic = document.getElementById(`day-icon-${i}`);
            if (c.classList.contains('hidden')) { c.classList.remove('hidden'); ic.style.transform = 'rotate(0deg)'; } else { c.classList.add('hidden'); ic.style.transform = 'rotate(-90deg)'; }
        };

        function generateDateSlots(s, e) {
            const con = document.getElementById('timeline-container');
            con.innerHTML = '';
            let c = new Date(s);
            const f = new Date(e);
            let i = 0;
            tripDays = [];
            while (c <= f) {
                const d = c.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' });
                tripDays.push(d);
                con.innerHTML += `<div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden mb-3"><div onclick="toggleDay(${i})" class="bg-white px-4 py-3 border-b border-gray-100 flex justify-between items-center cursor-pointer select-none"><div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-indigo-50 flex items-center justify-center"><i id="day-icon-${i}" class="fas fa-chevron-down text-indigo-500 text-xs chevron-icon"></i></div><h3 class="font-bold text-sm text-slate-700 capitalize">${d}</h3> <button onclick="event.stopPropagation(); addNoteToDay(${i})" class="ml-2 text-indigo-400 hover:text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-xs" title="Aggiungi Nota"><i class="fas fa-sticky-note"></i> +</button></div><span id="count-${i}" class="text-[9px] font-bold bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full uppercase">0 stop</span></div><div id="day-content-${i}" class="day-slot min-h-[80px] p-3 space-y-2 bg-slate-50/50"><div class="empty-placeholder text-center py-4 opacity-40 pointer-events-none"><i class="far fa-map text-slate-300 mb-1"></i><p class="text-[10px] text-slate-400">Trascina qui</p></div></div></div>`;
                c.setDate(c.getDate() + 1);
                i++;
            }
            return tripDays;
        }

        function initDragAndDrop() {
            const p = document.getElementById('suggestions-pool');
            new Sortable(p, { group: { name: 'p', pull: 'clone', put: false }, sort: false, animation: 150, ghostClass: 'bg-indigo-50', chosenClass: 'scale-95' });
            document.querySelectorAll('.day-slot').forEach(s => {
                new Sortable(s, {
                    group: 'p',
                    animation: 150,
                    onAdd: (e) => {
                        const it = e.item;
                        const id = it.dataset.id;
                        if (it.classList.contains('in-timeline')) { updateCount(); return; }
                        if (addedPlaces.has(String(id))) { it.remove(); return; }
                        it.remove();
                        const p = allLoadedPlaces.find(x => String(x.id) === String(id));
                        if (p) {
                            const nc = createCard(p, true);
                            if (e.newIndex >= s.children.length) s.appendChild(nc); else s.insertBefore(nc, s.children[e.newIndex]);
                            markAsAdded(id);
                            updateCount();
                        }
                    },
                    onRemove: updateCount,
                    onEnd: updateCount
                });
            });
        }
    </script>
</body>
</html>